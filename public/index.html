<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CF Worker DO WebSocket Test</title>
    <style>
      body { font-family: system-ui, sans-serif; padding: 1rem; }
      #status { margin-bottom: .5rem; }
      #log { white-space: pre-wrap; border: 1px solid #ccc; padding: .5rem; height: 300px; overflow: auto; }
    </style>
  </head>
  <body>
    <div id="status">disconnected</div>
    <input id="wsurl" size="80" placeholder="wss://<your-worker-domain>/websocket" />
    <div>
      <button id="connect">Connect</button>
      <button id="send">Send test message</button>
      <button id="close">Close</button>
    </div>
    <div id="log"></div>
    <script>
      const statusEl = document.getElementById('status');
      const logEl = document.getElementById('log');
      const urlEl = document.getElementById('wsurl');
      const btnConnect = document.getElementById('connect');
      const btnSend = document.getElementById('send');
      const btnClose = document.getElementById('close');

      let ws = null;
      let reconnectTimer = null;
      let reconnectDelay = 1000; // start with 1s, backoff to max 10s

      function log(msg) {
        console.log(msg);
        logEl.textContent += `\n${new Date().toISOString()} ${msg}`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setStatus(s) { statusEl.textContent = s; }

      function connect() {
        const url = urlEl.value.trim();
        if (!url) { alert('Enter WebSocket URL'); return; }
        log(`connecting to ${url}`);
        setStatus('connecting');
        ws = new WebSocket(url);
        ws.onopen = () => {
          setStatus('connected');
          log('ws open');
          reconnectDelay = 1000; // reset backoff
        };
        ws.onmessage = (ev) => {
          log(`<- ${ev.data}`);
        };
        ws.onerror = (ev) => {
          log(`ws error: ${ev.message || ev}`);
        };
        ws.onclose = (ev) => {
          setStatus(`closed code=${ev.code} reason=${ev.reason}`);
          log(`ws close code=${ev.code} reason=${ev.reason}`);
          scheduleReconnect();
        };
      }

      function scheduleReconnect() {
        if (reconnectTimer) return;
        reconnectTimer = setTimeout(() => {
          reconnectTimer = null;
          reconnectDelay = Math.min(reconnectDelay * 2, 10000);
          connect();
        }, reconnectDelay);
      }

      btnConnect.onclick = connect;
      btnSend.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          const msg = `hello-${Math.random().toString(36).slice(2,7)}`;
          log(`-> ${msg}`);
          ws.send(msg);
        } else {
          log('ws not open');
        }
      };
      btnClose.onclick = () => { if (ws) ws.close(1000, 'client close'); };
    </script>
  </body>
</html>
